{% extends "base.html" %}

{% block title %}{{ group.name }} - åœ˜è³¼è©³æƒ…{% endblock %}
{% block page_title %}åœ˜è³¼è©³æƒ…{% endblock %}

{% block content %}
<!-- Back Button -->
<div class="mb-4">
    <a href="{{ url_for('browse') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> è¿”å›åœ˜è³¼åˆ—è¡¨
    </a>
</div>

<!-- Group Info Card -->
<div class="row">
    <div class="col-lg-8">
        <!-- Main Info Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-shopping-cart"></i> {{ group.name }}
                </h6>
                <span class="status-badge badge-{% if group.status == 'ACTIVE' %}success{% elif group.status == 'SUCCESS' %}info{% else %}secondary{% endif %}">
                    {% if group.status == 'ACTIVE' %}
                        ğŸŸ¢ é€²è¡Œä¸­
                    {% elif group.status == 'SUCCESS' %}
                        âœ… åœ˜è³¼æˆåŠŸ
                    {% elif group.status == 'CLOSED' %}
                        ğŸ”’ å·²é—œé–‰
                    {% else %}
                        âŒ å·²å¤±æ•—
                    {% endif %}
                </span>
            </div>
            <div class="card-body">
                <!-- Product Image -->
                {% if group.product.image_url %}
                <div class="text-center mb-4">
                    <img src="{{ group.product.image_url }}" alt="{{ group.product.name }}" 
                         class="product-image-detail">
                </div>
                {% endif %}

                <!-- Product Info -->
                <div class="group-summary mb-4">
                    <div class="row text-center">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <h6><i class="fas fa-box"></i> å•†å“</h6>
                            <div class="value">{{ group.product.name }}</div>
                        </div>
                        <div class="col-md-4 mb-3 mb-md-0">
                            <h6><i class="fas fa-dollar-sign"></i> å–®åƒ¹</h6>
                            <div class="value">${{ group.product.price }}</div>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-users"></i> ç›®æ¨™äººæ•¸</h6>
                            <div class="value">{{ group.target_quantity }} äºº</div>
                        </div>
                    </div>
                </div>

                <!-- Group Details -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="info-item">
                            <small class="text-muted d-block mb-1">
                                <i class="fas fa-user-crown"></i> åœ˜é•·
                            </small>
                            <strong class="text-dark">{{ group.leader.name }}</strong>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <small class="text-muted d-block mb-1">
                                <i class="fas fa-clock"></i> æˆªæ­¢æ™‚é–“
                            </small>
                            <strong class="{% if group.is_expired %}text-danger deadline-warning{% else %}text-success{% endif %}">
                                {{ group.deadline.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}
                                {% if group.is_expired %}
                                    (å·²éæœŸ)
                                {% endif %}
                            </strong>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                {% if group.description %}
                <div class="mb-4">
                    <h6 class="font-weight-bold text-gray-700 mb-3">
                        <i class="fas fa-info-circle"></i> åœ˜è³¼èªªæ˜
                    </h6>
                    <div class="p-3 bg-light rounded">
                        <p class="text-gray-700 mb-0" style="white-space: pre-line;">{{ group.description }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- Progress Section -->
                <div class="mb-4">
                    <h6 class="font-weight-bold text-gray-700 mb-3">
                        <i class="fas fa-chart-line"></i> åœ˜è³¼é€²åº¦
                    </h6>
                    <div class="progress progress-group mb-3" style="height: 40px;">
                        <div class="progress-bar bg-{% if group.progress_percentage >= 100 %}success{% elif group.progress_percentage >= 70 %}info{% else %}primary{% endif %}" 
                             role="progressbar" 
                             style="width: {{ group.progress_percentage }}%;" 
                             aria-valuenow="{{ group.current_quantity }}" 
                             aria-valuemin="0" 
                             aria-valuemax="{{ group.target_quantity }}">
                            {{ group.current_quantity }} / {{ group.target_quantity }} äºº ({{ group.progress_percentage }}%)
                        </div>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="stat-card card bg-primary text-white">
                                <div class="card-body py-3">
                                    <div class="h4 mb-0">{{ group.current_quantity }}</div>
                                    <small>å·²åƒèˆ‡</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-card card bg-warning text-white">
                                <div class="card-body py-3">
                                    <div class="h4 mb-0">{{ group.remaining_slots }}</div>
                                    <small>å‰©é¤˜åé¡</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-card card bg-success text-white">
                                <div class="card-body py-3">
                                    <div class="h4 mb-0">{{ group.target_quantity }}</div>
                                    <small>ç›®æ¨™äººæ•¸</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Join Form -->
                {% if session.get('user_id') and group.status == 'ACTIVE' and not group.is_expired and group.remaining_slots > 0 %}
                <div class="card bg-gradient-primary text-white mb-4">
                    <div class="card-body">
                        <h5 class="text-white mb-3">
                            <i class="fas fa-shopping-cart"></i> ç«‹å³è·Ÿåœ˜
                        </h5>
                        <form method="POST" action="{{ url_for('join_group', group_id=group.id) }}" id="joinForm">
                            <div class="row align-items-end">
                                <div class="col-md-5 mb-3">
                                    <label for="quantity" class="text-white font-weight-bold">è³¼è²·æ•¸é‡</label>
                                    <input type="number" class="form-control form-control-lg" id="quantity" name="quantity" 
                                           min="1" max="{{ group.remaining_slots }}" value="1" required
                                           onchange="updateTotal()">
                                    <small class="text-white-50">
                                        æœ€å¤šå¯è³¼è²· {{ group.remaining_slots }} ä»¶
                                    </small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="text-white font-weight-bold">ç¸½é‡‘é¡</label>
                                    <div class="bg-white text-dark rounded p-2 text-center">
                                        <h4 class="mb-0 text-danger" id="totalPrice">
                                            ${{ group.product.price }}
                                        </h4>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <button type="submit" class="btn btn-warning btn-block btn-lg font-weight-bold">
                                        <i class="fas fa-check-circle"></i> ç¢ºèªè·Ÿåœ˜
                                    </button>
                                </div>
                            </div>
                            <div class="alert alert-light mb-0">
                                <small class="text-dark">
                                    <i class="fas fa-info-circle"></i> 
                                    è·Ÿåœ˜å¾Œï¼Œè«‹ç­‰å¾…åœ˜è³¼é”åˆ°ç›®æ¨™äººæ•¸ã€‚åœ˜è³¼æˆåŠŸå¾Œï¼Œåœ˜é•·æœƒé€šçŸ¥å–è²¨äº‹å®œã€‚
                                </small>
                            </div>
                        </form>
                    </div>
                </div>
                
                <script>
                    const unitPrice = {{ group.product.price }};
                    function updateTotal() {
                        const quantity = document.getElementById('quantity').value || 1;
                        const total = (unitPrice * quantity).toFixed(2);
                        document.getElementById('totalPrice').textContent = '$' + total;
                    }
                </script>
                {% elif not session.get('user_id') %}
                <div class="alert alert-warning">
                    <h5 class="alert-heading">
                        <i class="fas fa-exclamation-triangle"></i> éœ€è¦ç™»å…¥
                    </h5>
                    <p class="mb-0">
                        è«‹å…ˆ <a href="{{ url_for('login') }}" class="alert-link font-weight-bold">ç™»å…¥</a> 
                        æˆ– <a href="{{ url_for('register') }}" class="alert-link font-weight-bold">è¨»å†Š</a> 
                        æ‰èƒ½åƒèˆ‡åœ˜è³¼
                    </p>
                </div>
                {% elif group.status != 'ACTIVE' %}
                <div class="alert alert-secondary">
                    <h5 class="alert-heading">
                        <i class="fas fa-info-circle"></i> åœ˜è³¼å·²çµæŸ
                    </h5>
                    <p class="mb-0">æ­¤åœ˜è³¼å·²ç¶“çµæŸï¼Œç„¡æ³•å†åƒèˆ‡</p>
                </div>
                {% elif group.is_expired %}
                <div class="alert alert-danger">
                    <h5 class="alert-heading">
                        <i class="fas fa-clock"></i> åœ˜è³¼å·²éæœŸ
                    </h5>
                    <p class="mb-0">æ­¤åœ˜è³¼å·²è¶…éæˆªæ­¢æ™‚é–“</p>
                </div>
                {% elif group.remaining_slots == 0 %}
                <div class="alert alert-success">
                    <h5 class="alert-heading">
                        <i class="fas fa-check-circle"></i> åœ˜è³¼å·²é¡æ»¿
                    </h5>
                    <p class="mb-0">æ­¤åœ˜è³¼å·²é”åˆ°ç›®æ¨™äººæ•¸ï¼Œæ­å–œåœ˜è³¼æˆåŠŸï¼</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Participants Sidebar -->
    <div class="col-lg-4">
        <!-- Participants Card -->
        <div class="card shadow mb-4 detail-sidebar">
            <div class="card-header py-3 bg-gradient-primary">
                <h6 class="m-0 font-weight-bold text-white">
                    <i class="fas fa-users"></i> åƒèˆ‡æˆå“¡ ({{ orders|length }})
                </h6>
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                {% if orders %}
                    {% for order in orders %}
                    <div class="member-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1 font-weight-bold">
                                    <i class="fas fa-user-circle text-primary"></i>
                                    {{ order.user.name }}
                                </h6>
                                <small class="text-muted">
                                    {{ order.created_at.strftime('%m/%d %H:%M') }}
                                </small>
                            </div>
                            <div class="text-right">
                                <span class="badge badge-primary badge-pill">
                                    {{ order.quantity }} ä»¶
                                </span>
                                <div class="text-muted small mt-1">
                                    ${{ order.total_price }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-users fa-3x text-gray-300 mb-3"></i>
                    <p class="text-muted mb-0">
                        é‚„æ²’æœ‰äººè·Ÿåœ˜<br>
                        <strong>æˆç‚ºç¬¬ä¸€å€‹åƒèˆ‡è€…ï¼</strong>
                    </p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Product Details Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-gradient-info">
                <h6 class="m-0 font-weight-bold text-white">
                    <i class="fas fa-box-open"></i> å•†å“è³‡è¨Š
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">å•†å“åç¨±</small>
                    <h6 class="font-weight-bold">{{ group.product.name }}</h6>
                </div>
                
                {% if group.product.description %}
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">å•†å“æè¿°</small>
                    <p class="text-gray-700 small mb-0">{{ group.product.description }}</p>
                </div>
                {% endif %}
                
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">å–®åƒ¹</small>
                    <div class="price-tag">
                        ${{ group.product.price }}
                    </div>
                </div>
                
                <div class="alert alert-info mb-0">
                    <small>
                        <i class="fas fa-info-circle"></i>
                        åœ˜è³¼æˆåŠŸå¾Œï¼Œæ¯äººå¯äº«æ­¤å„ªæƒ åƒ¹æ ¼
                    </small>
                </div>
            </div>
        </div>

        <!-- Share Card -->
        <div class="card shadow mb-4 bg-gradient-success text-white">
            <div class="card-body text-center">
                <h6 class="text-white mb-3">
                    <i class="fas fa-share-alt"></i> åˆ†äº«çµ¦æœ‹å‹
                </h6>
                <p class="small mb-3">é‚€è«‹æ›´å¤šäººåƒåŠ ï¼Œåœ˜è³¼æ›´å¿«æˆåŠŸï¼</p>
                <button class="btn btn-light btn-sm" onclick="copyLink()">
                    <i class="fas fa-copy"></i> è¤‡è£½é€£çµ
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function copyLink() {
    const link = window.location.href;
    navigator.clipboard.writeText(link).then(() => {
        alert('âœ… é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
    });
}
</script>

{% endblock %}
